#!/bin/bash
set -euo pipefail # -e: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ, -u: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, -o pipefail: –æ—à–∏–±–∫–∞ –≤ –ø–∞–π–ø–µ –≤–µ–¥–µ—Ç –∫ –≤—ã—Ö–æ–¥—É

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, —á—Ç–æ –∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ –±—ç–∫–∞–ø–∞ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
RCLONE_COMMON_ARGS=(
    --transfers=100
    --checkers=100
    --fast-list
    --multi-thread-streams=32
    --multi-thread-chunk-size=128M
    --buffer-size=64M
    --log-level INFO
    --fix-case
    --progress
    --stats-one-line
)

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è. –ú–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è,
# –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–∫—Ä–∏–ø—Ç–µ.
RCLONE_PASSWORD_COMMAND="${RCLONE_PASSWORD_COMMAND:-"pass rclone/config"}"

# --- –õ–û–ì–ò–ö–ê –°–ö–†–ò–ü–¢–ê ---

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
run_restore() {
    local src="$1"
    local dst="$2"
    local extra_args=("${@:3}") # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã - —ç—Ç–æ –º–∞—Å—Å–∏–≤

    echo "--- –ù–∞—á–∏–Ω–∞—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: $src -> $dst ---"
    if rclone sync "$src" "$dst" "${RCLONE_COMMON_ARGS[@]}" "${extra_args[@]}"; then
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: $dst"
        return 0
    else
        echo "‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏: $dst"
        return 1
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    # --- –í–ê–ñ–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï ---
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! ‚ö†Ô∏è"
    echo "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—ç–∫–∞–ø–∞."
    echo "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –£–î–ê–õ–ï–ù–ò–Æ –∏–ª–∏ –ü–ï–†–ï–ó–ê–ü–ò–°–ò –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Ü–µ–ª–µ–≤—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö."
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å."
    echo
    read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (–í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è): " confirmation

    if [ "$confirmation" != "yes" ]; then
        echo "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
        exit 0
    fi

    echo "–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è..."
    export RCLONE_PASSWORD_COMMAND

    # –°—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    error_count=0

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
    # –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞: remote -> local
    run_restore "projects:" "$HOME/projects/" --exclude="**/{node_modules,.next,target,.venv}/**" --exclude="**/cpython**" || ((error_count++))
    run_restore "configs:.kube/" "$HOME/.kube/" --exclude="cache/**" || ((error_count++))
    run_restore "configs:.talos/" "$HOME/.talos/" || ((error_count++))
    run_restore "configs:.ssh/" "$HOME/.ssh/" || ((error_count++))
    run_restore "configs:Pictures/" "$HOME/Pictures/" || ((error_count++))
    run_restore "configs:.zen/" "$HOME/.zen/" || ((error_count++))
    run_restore "configs:.docker/" "$HOME/.docker/" || ((error_count++))
    run_restore "configs:.gpg/" "$HOME/.gpg/" || ((error_count++))

    echo "=== –í—Å–µ –∑–∞–¥–∞—á–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã ==="
    if [ "$error_count" -gt 0 ]; then
        echo "‚ö†Ô∏è –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: $error_count"
        exit 1
    else
        echo "üéâ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
        exit 0
    fi
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main
